# 汇编学习笔记 Note.asm

## Debug 命令

| 命令             | 全名       | 用途           |
| ---------------- | ---------- | -------------- |
| `r`              | Register   | 读取寄存器     |
| `d [dst] [len]`  | Dump       | 读取内存       |
| `e <dst> [data]` | Enter      | 写入内存       |
| `u [dst]`        | Unassemble | 翻译内存为指令 |
| `t`              | Trace      | 运行上一条指令 |
| `a [dst]`        | Assemble   | 写入内存为指令 |

## 寄存器

| 简写 | 全名                | 中文名         | 特殊用途                                        |
| ---- | ------------------- | -------------- | ----------------------------------------------- |
| `AX` | Accumulator         | 累加寄存器     |                                                 |
| `BX` | Base                | 基址寄存器     | 作为偏移地址，`mov ax,[bx+2]`                   |
| `CX` | Count               | 计数寄存器     |                                                 |
| `DX` | Data                | 数据寄存器     |                                                 |
| `BP` | Base Pointer        | 基址指针寄存器 |                                                 |
| `SI` | Source Index        | 源变址寄存器   | 作为偏移地址，`mov ax,[si+2]`                   |
| `DI` | Destination Index   | 目的变址寄存器 | 作为偏移地址，`mov ax,[di+2]`                   |
| `IP` | Instruction Pointer | 指令指针寄存器 | 当前代码的偏移地址， `CS:IP` 即为当前操作       |
| `CS` | Code Segment        | 代码段寄存器   | 当前代码的段地址， `CS:IP` 即为当前操作         |
| `DS` | Data Segment        | 数据段寄存器   | 当前段地址，`[x]` 即为 `DS:x` 地址              |
| `SS` | Stack Segment       | 堆栈段寄存器   | 当前栈顶的段地址， `SS:SP` 即为当前栈顶的元素   |
| `SP` | Stack Pointer       | 栈指针寄存器   | 当前栈顶的偏移地址， `SS:SP` 即为当前栈顶的元素 |
| `ES` | Extra Segment       | 附加段寄存器   |                                                 |

`X[L/H]` 表示 `X` 寄存器的 低/高八位 。

## 指令

### 算数

| 指令                     | 用途                                                                       | 备注                                            |
| ------------------------ | -------------------------------------------------------------------------- | ----------------------------------------------- |
| `mov <dst>,<src>`        | `dst = src`                                                                |                                                 |
| `add <dst>,<src>`        | `dst += src`                                                               |                                                 |
| `sub <dst>,<src>`        | `dst -= src`                                                               |                                                 |
| `mul [dst]{AX/AL},<src>` | `dst *= src`                                                               | 16位乘法结果低八位默认在 `AX` 高八位默认在 `DX` |
| `div <src>`              | `AX = DX:AX / src; DX = DX:AX % src` </br> `AL = AX / src; AH = AX % src;` | 前者为16位除数，后者为8位除数                   |
| `neg <x>`                | `x = -x` (Equals to `x ^= !0; x++` and `x ^= (!0 >> 1); x \|= (1 << 15)`)  |

除16位乘法外，溢出部分舍弃

### 逻辑

| 指令              | 用途          | 备注 |
| ----------------- | ------------- | ---- |
| `and <dst>,<src>` | `dst &= src`  |      |
| `or <dst>,<src>`  | `dst \|= src` |      |

### 位

| 指令              | 用途                          | 备注                     |
| ----------------- | ----------------------------- | ------------------------ |
| `shl <src>,<val>` | `src <<= val`                 |                          |
| `shr <src>,<val>` | `src >>= val`                 |                          |
| `rol <src>,<val>` | `src = src.rotate_left(val)`  | `rotate_left()` in Rust  |
| `ror <src>,<val>` | `src = src.rotate_right(val)` | `rotate_right()` in Rust |
| `inc <src>`       | `src++`                       |                          |
| `dec <src>`       | `src--`                       |                          |

### 特殊

| 指令           | 用途                                                                              | 备注                                          |
| -------------- | --------------------------------------------------------------------------------- | --------------------------------------------- |
| `xchg <a>,<b>` | `swap(a, b)`                                                                      | `swap()` in Rust `std::mem`                   |
| `nop`          | 空指令                                                                            |                                               |
| `int <x>`      | 产生中断 `x`                                                                      |                                               |
| `jmp <dst>`    | 跳转至 `dst`                                                                      | 本质上是在修改 `CS` 和 `IP` ，或者只修改 `IP` |
| `push <src>`   | 将 `SS:SP` 作为栈顶，依次推入 `XH` `XL` ，如果 `src` 是***整个***寄存器的话       | `SP` 同时会回退，比如 `E` 变到 `F`            |
| `pop <dst>`    | 将 `SS:SP` 作为栈顶，依次退出并存至 `XL` `XH` ，如果 `src` 是***整个***寄存器的话 | `SP` 同时会回退，比如 `E` 变到 `F`            |

### 地址

物理地址 `Physical` = 段地址 `Segment` * 16 + 偏移地址 `Offset`

| 寻址方式    | 段地址 | 偏移地址  |
| ----------- | ------ | --------- |
| `[i]`       | `DS`   | `i`       |
| `[bx]`      | `DS`   | `BX`      |
| `[si]`      | `DS`   | `si`      |
| `[di]`      | `DS`   | `di`      |
| `[bp]`      | `SS`   | `BP`      |
| `[bx+i]`    | `DS`   | `bx+i`    |
| `[si+i]`    | `DS`   | `si+i`    |
| `[di+i]`    | `DS`   | `di+i`    |
| `[bp+i]`    | `SS`   | `bp+i`    |
| `[bx+si]`   | `DS`   | `bx+si`   |
| `[bx+di]`   | `DS`   | `bx+di`   |
| `[bp+si]`   | `SS`   | `bp+si`   |
| `[bp+di]`   | `SS`   | `bp+di`   |
| `[bx+si+i]` | `DS`   | `bx+si+i` |
| `[bx+di+i]` | `DS`   | `bx+di+i` |
| `[bp+si+i]` | `SS`   | `bp+si+i` |
| `[bp+di+i]` | `SS`   | `bp+di+i` |
| `[i]`       | `SS`   | `i`       |
| `[i]`       | `DS`   | `i`       |
| `[i]`       | `DS`   | `i`       |

#### `DS`

`DS` 寄存器记录的是当前的段地址，在执行指令时，可以只给出一个偏移地址，组合形成内存地址。

例如 `mov ax,[0]` 表示将 `DS:0-DS:1` 处的数据存至 `AX` 。又例如 `mov al,[1]` 表示将 `DS:1` 处的数据存至 `AL` 。

#### `SS`

除了作为栈顶段地址外，这也是使用 `[reg]` 寻址时默认的段地址。

#### `BX` `BP` `SI` `DI`

作为偏移地址，`[]` 不能存在除了这四个寄存器和数字以外的其他值。

例如 `[bx+1]` `[si+bx]` `[si+di+1]` `[bx]` 。

但是 `[bx+si+di+2]` 这种是不可以的。
